((function(){var a,b,c,d,e,f;a=0,b=["ms","moz","webkit","o"],d=function(a){return window.requestAnimationFrame=window[b[a]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[a]+"CancelAnimationFrame"]||window[b[a]+"CancelRequestAnimationFrame"]};for(c=e=0,f=b.length;0<=f?e<=f:e>=f;c=0<=f?++e:--e)d.call(this,c);window.requestAnimationFrame||(window.requestAnimationFrame=function(b,c){var d,e,f;return d=(new Date).getTime(),f=Math.max(0,16-(d-a)),e=window.setTimeout(function(){return b(d+f)},f),a=d+f,e});if(!window.cancelAnimationFrame)return window.cancelAnimationFrame=function(a){return window.clearTimeout(a)}})).call(this),CanvasRenderingContext2D.prototype.roundRect=function(a,b,c,d,e){return c<2*e&&(e=c/2),d<2*e&&(e=d/2),e===0&&(e=1),this.beginPath(),this.moveTo(a+e,b),this.arcTo(a+c,b,a+c,b+d,e),this.arcTo(a+c,b+d,a,b+d,e),this.arcTo(a,b+d,a,b,e),this.arcTo(a,b,a+c,b,e),this.closePath(),this},window.addEventListener||(window.addEventListener=function(a,b,c){return window.attachEvent?window.attachEvent("on"+a,b):window["on"+a]=b}),window.addEventListener("load",function(){return setTimeout(function(){return window.scrollTo(0,1)},0)}),window.module||(window.module=!1);var Constants;Constants={SCALE:.1,SCALE_INV:10,BOTTOM:60,BASE_WIDTH:480,BASE_HEIGHT:268,ENEMY_VEL:.5,BALL_RADIUS:10,BALL_MASS:1.4,MSG_FONT:"'Press Start 2P', Courier, monospace, sans-serif",TICK_DURATION:16,FRAME_DELAY:5,STATE_SAVE:200,SAVE_LIFETIME:5e3,TARGET_LATENCY:50,ASSETS:{bus:"assets/images/bus.svg",gamepad:"assets/images/gamepad.png",playerUp:"assets/images/player-up.svg",playerDown:"assets/images/player-down.svg",crowdUp:"assets/images/crowd-up.svg",crowdDown:"assets/images/crowd-down.svg",bush:"assets/images/bush.svg",road:"assets/images/road.svg",building:"assets/images/building.svg"}},module&&(module.exports=Constants);var Helpers;Helpers={round:function(a){return.5+a<<0},inRect:function(a,b,c,d,e,f){return a>c&&a<c+e&&b>d&&b<d+f},deg2Rad:function(a){return a*Math.PI/180},rad2Deg:function(a){return a*180/Math.PI},yFromAngle:function(a){return-Math.cos(Helpers.deg2Rad(a))},xFromAngle:function(a){return Math.sin(Helpers.deg2Rad(a))},rand:function(a){return Math.floor(Math.random()*(a+1))},dist:function(a,b){return Math.sqrt(Math.pow(a.x-b.x,2)+Math.pow(a.y-b.y,2))},mag:function(a){return Math.sqrt(Math.pow(a.x,2)+Math.pow(a.y,2))}},module&&(module.exports=Helpers);var SceneManager;SceneManager=function(){function a(a){this.canvas=a,this.sceneStack=[],this.currScene=null}return a.name="SceneManager",a.prototype.pushScene=function(a){return this.sceneStack.push(a),this.currScene&&(this.currScene.stop(),this.currScene.ctx=null),this.currScene=a,this.currScene.ctx=this.ctx,this.currScene.initialized?this.currScene.start():this.currScene.init()},a.prototype.popScene=function(){var a;return this.currScene&&(this.currScene.stop(),this.currScene.ctx=null),a=this.sceneStack.pop(),a&&a.destroy&&a.destroy(),this.currScene=this.sceneStack[this.sceneStack.length-1]||null,this.currScene&&(this.currScene.ctx=this.ctx,this.currScene.start()),a},a}();var Scene,__hasProp=Object.prototype.hasOwnProperty;Scene=function(){function a(){var a=this;this.stopped=!0,this.initialized=!1,this.lastTimeout=0,this.width=Globals.Manager.canvas.width,this.height=Globals.Manager.canvas.height,this.center={x:this.width/2,y:this.height/2},this.canvas=Globals.Manager.canvas,this.ctx=this.canvas.getContext("2d"),this.buttons||(this.buttons={}),this.stepCallback=function(b){return a.step(b)}}return a.name="Scene",a.prototype.init=function(){return this.stopped=!1,this.initialized=!0,this.step((new Date).getTime())},a.prototype.start=function(){return this.stopped=!1,this.step((new Date).getTime())},a.prototype.step=function(a){},a.prototype.next=function(){if(!this.stopped)return this.lastTimeout=window.requestAnimationFrame(this.stepCallback)},a.prototype.stop=function(){return this.stopped=!0,window.cancelAnimationFrame(this.lastTimeout)},a.prototype.click=function(a){var b,c,d,e;d=this.buttons,e=[];for(c in d){if(!__hasProp.call(d,c))continue;b=d[c],e.push(b.handleClick(a))}return e},a.prototype.mousedown=function(a){var b,c,d,e;d=this.buttons,e=[];for(c in d){if(!__hasProp.call(d,c))continue;b=d[c],e.push(b.handleMouseDown(a))}return e},a.prototype.mousemove=function(a){var b,c,d,e;d=this.buttons,e=[];for(c in d){if(!__hasProp.call(d,c))continue;b=d[c],e.push(b.handleMouseMove(a))}return e},a.prototype.mouseup=function(a){var b,c,d,e;d=this.buttons,e=[];for(c in d){if(!__hasProp.call(d,c))continue;b=d[c],e.push(b.handleMouseUp(a))}return e},a.prototype.mouseout=function(a){},a.prototype.buttonPressed=function(){},a}();var Loader;Loader=function(){function a(){this.progress=0,this.assets={},this.totalAssets=0,this.loadedAssets=0}return a.name="Loader",a.prototype.updateProgress=function(){this.progress=this.loadedAssets/this.totalAssets,this.onprogress&&this.onprogress(this.progress);if(this.progress===1&&this.onload)return this.onload()},a.prototype.load=function(a){var b,c,d;d=[];for(c in a)b=a[c],d.push(this.loadAsset(c,b));return d},a.prototype.loadAsset=function(a,b){var c,d;return c=new Image,d=this,c.onload=function(){return this.loaded=!0,d.loadedAssets++,d.updateProgress()},this.assets[a]={loader:this,src:b,image:c},this.totalAssets++,c.src=b},a.prototype.loadProgress=function(a){return this.onprogress=a},a.prototype.loadComplete=function(a){return this.onload=a},a.prototype.getAsset=function(a){return this.assets[a].image},a}();var Input,__hasProp=Object.prototype.hasOwnProperty;Input=function(){function a(){var a,b,c,d,e,f,g,h,i,j,k,l,m=this;this.keys={},this.anyInput=!1,k=function(a){return a.which||(a.which=a.charCode),a.which||(a.which=a.keyCode),a},j=function(a){var b,c;return c=Globals.Manager.canvas,b=c.getBoundingClientRect(),a.x=(a.x-b.left)*(c.width/b.width),a.y=(a.y-b.top)*(c.height/b.height),a},l=function(a){var b,c,d;return b=Globals.Manager.canvas,c=a.clientX||a.x||a.layerX,d=a.clientY||a.y||a.layerY,j({x:c,y:d,identifier:a.identifier})},c=function(a){var b,c;return m.anyInput=!0,c=k(a),c.which>=37&&c.which<=40&&c.preventDefault(),c.which===27&&(b=document.getElementById("ui"),b&&b.setAttr("style","display: none;")),m.keys["key"+c.which]=!0},d=function(a){return m.anyInput=!1,m.keys["key"+k(a).which]=!1},h=function(a){return m.anyInput=!1,a=l(a),Globals.Manager.currScene.mouseup(a)},e=function(a){return m.anyInput=!0,a=l(a),Globals.Manager.currScene.mousedown(a)},f=function(a){return a=l(a),Globals.Manager.currScene.mousemove(a)},b=function(a){return a=l(a),Globals.Manager.currScene.click(a)},g=function(a){return a=l(a),Globals.Manager.currScene.mouseout(a)},i=function(a){return function(a){return function(b){var c,d,e,f;b.preventDefault(),f=b.changedTouches;for(d=0,e=f.length;d<e;d++)c=f[d],a({x:c.clientX,y:c.clientY,identifier:c.identifier})}}.call(this,a)},a=Globals.Manager.canvas,document.addEventListener("keydown",c,!0),document.addEventListener("keyup",d,!0),a.addEventListener("mouseup",h,!0),a.addEventListener("mousedown",e,!0),a.addEventListener("mousemove",f,!0),a.addEventListener("mouseout",g,!0),a.addEventListener("click",b,!0),a.addEventListener("touchstart",i(e),!0),a.addEventListener("touchend",i(h),!0),a.addEventListener("touchmove",i(f),!0),a.addEventListener("touchcancel",i(h),!0),this.shortcuts={left:["key37","key65"],right:["key39","key68"],up:["key38","key87"],down:["key40","key83"]}}return a.name="Input",a.prototype.left=function(a){return this.keys[this.shortcuts.left[a]]||!1},a.prototype.right=function(a){return this.keys[this.shortcuts.right[a]]||!1},a.prototype.up=function(a){return this.keys[this.shortcuts.up[a]]||!1},a.prototype.down=function(a){return this.keys[this.shortcuts.down[a]]||!1},a.prototype.reset=function(){var a,b,c,d;c=this.keys,d=[];for(a in c)b=c[a],d.push(this.keys[a]=!1);return d},a.prototype.getState=function(a){return{left:this.keys[this.shortcuts.left[a]],right:this.keys[this.shortcuts.right[a]],up:this.keys[this.shortcuts.up[a]],down:this.keys[this.shortcuts.down[a]]}},a.prototype.set=function(a,b,c){return c==null&&(c=0),this.keys[this.shortcuts[a][c]]=b},a.prototype.setState=function(a,b){var c,d,e;b==null&&(b=0),e=[];for(c in a){if(!__hasProp.call(a,c))continue;d=a[c],e.push(this.keys[this.shortcuts[c][b]]=d)}return e},a}();var Constants,Sprite;module&&(Constants=require("./constants")),Sprite=function(){function a(a,b,c,d,e,f){this.x=a,this.y=b,this.width=c,this.height=d,this.bg=e,this.id=f!=null?f:!1,this.velocity||(this.velocity={x:0,y:0}),this.rot=0,this.rotVel=0,this.acceleration||(this.acceleration={x:0,y:Constants.GRAVITY}),this.mass||(this.mass=1),this.stop=!1,this.left=this.x,this.right=this.x+this.width,this.top=this.y,this.bottom=this.top+this.y,this.remove=!1}return a.name="Sprite",a.prototype.setPosition=function(a,b){return b||(a.y&&(b=a.y),a.x&&(a=a.x)),this.x=a,this.y=b},a.prototype.incrementPosition=function(a){if(this.stop)return;return this.x+=this.velocity.x*a,this.y+=this.velocity.y*a,this.rot+=this.rotVel*a,this.velocity.x+=this.acceleration.x*this.mass*a*a,this.left=this.x,this.right=this.left+this.width,this.top=this.y,this.bottom=this.top+this.height},a.prototype.draw=function(a,b,c){var d,e;b||(b=this.x),c||(c=this.y);if(this.rot!==0)return a.save(),d=b+this.width/2,e=c+this.height/2,a.translate(d,e),a.rotate(this.rot),a.translate(-d,-e),this.bg&&a.drawImage(this.bg,b,c,this.width,this.height),a.restore();if(this.bg)return a.drawImage(this.bg,b,c,this.width,this.height)},a.prototype.getState=function(){return{x:this.x,y:this.y,width:this.width,height:this.height,velocity:{x:this.velocity.x,y:this.velocity.y}}},a.prototype.setState=function(a){if(!a)return;return this.x=a.x,this.y=a.y,this.width=a.width,this.height=a.height,this.velocity={x:a.velocity.x,y:a.velocity.y}},a}(),module&&(module.exports=Sprite);var Button,__hasProp=Object.prototype.hasOwnProperty,__extends=function(a,b){function d(){this.constructor=a}for(var c in b)__hasProp.call(b,c)&&(a[c]=b[c]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};Button=function(a){function b(a,c,d,e,f,g,h){this.x=a,this.y=c,this.width=d,this.height=e,this.img=f,this.downImg=g,this.scene=h,this.down=!1,b.__super__.constructor.call(this,this.x,this.y,this.width,this.height,this.img)}return __extends(b,a),b.name="Button",b.prototype.handleMouseDown=function(a){return this.down=Helpers.inRect(a.x,a.y,this.x,this.y,this.width,this.height)},b.prototype.handleMouseUp=function(a){return this.down&&Helpers.inRect(a.x,a.y,this.x,this.y,this.width,this.height)&&this.scene&&this.scene.buttonPressed(this),this.down=!1},b.prototype.handleMouseMove=function(a){if(this.down)return this.down=Helpers.inRect(a.x,a.y,this.x,this.y,this.width,this.height)},b.prototype.handleClick=function(a){return this.down=!1},b.prototype.draw=function(a){if(!this.img)return;return a.drawImage(this.down?this.downImg:this.img,Helpers.round(this.x),Helpers.round(this.y))},b}(Sprite);var GamePad;GamePad=function(){function a(a){this.btnRects=a,this.previousPos={}}return a.name="GamePad",a.prototype.inRect=function(a,b){return a?Helpers.inRect(a.x,a.y,b[0],b[1],b[2],b[3]):!1},a.prototype.findRect=function(a){var b,c,d;d=this.btnRects;for(b in d){c=d[b];if(this.inRect(a,c))return b}return null},a.prototype.savePreviousPos=function(a){return this.previousPos[(a.identifier||"0")+""]=a},a.prototype.getPreviousPos=function(a){return this.previousPos[(a.identifier||"0")+""]},a.prototype.handleMouseDown=function(a){var b;return b=this.findRect(a),b&&Globals.Input.set(b,!0),this.savePreviousPos(a)},a.prototype.handleMouseMove=function(a){var b,c,d;if(!a.identifier)return;b=this.findRect(a),d=this.getPreviousPos(a),c=d?this.findRect(d):null,this.savePreviousPos(a);if(c&&b===c)return Globals.Input.set(c,!0);if(c&&b!==c){Globals.Input.set(c,!1);if(b)return Globals.Input.set(b,!1)}},a.prototype.handleMouseUp=function(a){var b;return b=this.findRect(a),b&&Globals.Input.set(b,!1),this.savePreviousPos(a)},a.prototype.handleClick=function(){},a}();var Globals;Globals={Input:null,Manager:new SceneManager,Loader:new Loader};var StretchySprite,__hasProp=Object.prototype.hasOwnProperty,__extends=function(a,b){function d(){this.constructor=a}for(var c in b)__hasProp.call(b,c)&&(a[c]=b[c]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};StretchySprite=function(a){function b(a,c,d,e,f,g,h){this.x=a,this.y=c,this.width=d,this.height=e,this.rightCap=f,this.topCap=g,this.bg=h,this.generateStretchedImage(),b.__super__.constructor.call(this,this.x,this.y,this.width,this.height)}return __extends(b,a),b.name="StretchySprite",b.prototype.generateStretchedImage=function(){var a,b,c,d,e,f,g,h;return a=function(a,b){var c;return c=document.createElement("canvas"),c.width=a,c.height=b,c},f=a(this.width,2),c=a(8,this.height),g=f.getContext("2d"),g.drawImage(this.bg,0,this.topCap,this.bg.width,1,0,0,this.width,f.height),d=c.getContext("2d"),d.drawImage(this.bg,this.bg.width-this.rightCap-c.width,0,c.width,this.bg.height,0,this.height-this.bg.height,c.width,this.bg.height),this.stretchedImage=a(this.width,this.height),b=this.stretchedImage.getContext("2d"),b.drawImage(this.bg,this.x,this.y+this.height-this.bg.height),e=b.createPattern(c,"repeat-x"),b.fillStyle=e,b.fillRect(this.bg.width-this.rightCap,this.height-this.bg.height,this.width-this.bg.width,this.bg.height),h=b.createPattern(f,"repeat-y"),b.fillStyle=h,b.fillRect(0,this.topCap,this.width,this.height-this.bg.height),b.drawImage(this.bg,0,0,this.bg.width,this.topCap,0,0,this.width,this.topCap),b.drawImage(this.bg,this.bg.width-this.rightCap,0,this.rightCap,this.bg.height,this.width-this.rightCap,this.height-this.bg.height,this.rightCap,this.bg.height)},b.prototype.draw=function(a){return a.drawImage(this.stretchedImage,0,0)},b}(Sprite);var Constants,Message,Sprite,__hasProp=Object.prototype.hasOwnProperty,__extends=function(a,b){function d(){this.constructor=a}for(var c in b)__hasProp.call(b,c)&&(a[c]=b[c]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};module&&(Sprite=require("./sprite"),Constants=require("./constants")),Message=function(a){function b(a,b,c){this.msg=a,this.x=b,this.y=c,this.opacity=.5,this.fontSize=14}return __extends(b,a),b.name="Message",b.prototype.draw=function(a){var c;return this.ctx=a,this.ctx.font="bold "+this.fontSize+"px "+Constants.MSG_FONT,this.ctx.fillStyle="rgba( 255, 255, 255, "+this.opacity+")",this.ctx.textAlign="left",c="Score: "+this.score,this.ctx.lineWidth=1,this.ctx.strokeStyle="rgba( 0, 0, 0, 0.8 )",this.ctx.fillText(this.msg,this.x,this.y),this.ctx.strokeText(this.msg,this.x,this.y),b.__super__.draw.call(this,this.ctx)},b}(Sprite),module&&(module.exports=Message);var Constants,FoamEnemy,Sprite,__hasProp=Object.prototype.hasOwnProperty,__extends=function(a,b){function d(){this.constructor=a}for(var c in b)__hasProp.call(b,c)&&(a[c]=b[c]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};module&&(Sprite=require("./sprite"),Constants=require("./constants")),FoamEnemy=function(a){function b(a){var c;this.side=a!=null?a:"top",c=a==="top"?1:-1,this.alive=!0,this.width||(this.width=Globals.scene.world.p1.width),this.height||(this.height=Globals.scene.world.p1.height),this.x=Globals.scene.width/4+Math.random()*(Globals.scene.width/2),this.y=a==="top"?-1*this.height:Globals.scene.height,this.originalWidth=this.width,this.originalHeight=this.height,this.bg=Globals.Loader.getAsset(a==="top"?"crowdDown":"crowdUp"),b.__super__.constructor.call(this,this.x,this.y,this.width,this.height,this.bg),this.velocity.y=Constants.ENEMY_VEL*c*1}return __extends(b,a),b.name="FoamEnemy",b.prototype.incrementPosition=function(a){var c,d,e,f,g,h,i,j,k,l,m,n,o;b.__super__.incrementPosition.call(this,a);if(this.side==="top"&&this.bottom>Globals.scene.height*.12||this.side==="bottom"&&this.top<Globals.scene.height*.88)this.velocity.y=0;i=Globals.scene.world.p1,n=this.right>=i.left&&this.right<=i.right&&this.top<=i.bottom&&this.top>=i.top,o=i.right>=this.left&&i.right<=this.right&&i.top<=this.bottom&&i.top>=this.top,m=n||o,k=this.left<=i.right&&this.left>=i.left&&this.top<=i.bottom&&this.top>=i.top,l=i.left<=this.right&&i.left>=this.left&&i.top<=this.bottom&&i.top>=this.top,j=k||l,g=this.right>=i.left&&this.right<=i.right&&this.bottom>=i.top&&this.bottom<=i.bottom,h=i.right>=this.left&&i.right<=this.right&&i.bottom>=this.top&&i.bottom<=this.bottom,f=g||h,d=this.left<=i.right&&this.left>=i.left&&this.bottom>=i.top&&this.bottom<=i.bottom,e=i.left<=this.right&&i.left>=this.left&&i.bottom>=this.top&&i.bottom<=this.bottom,c=d||e,(m||j||f||c)&&this.alive&&(this.implode(),Globals.scene.enemyVel+=.33,Globals.scene.world.p1.toggleDirection(),Globals.scene.incrementScore(1e3+Globals.scene.time*100),Globals.scene.time=15,Globals.scene.loadFoamEnemy(this.side==="top"?"bottom":"top"),this.alive=!1);if(this.left>Globals.scene.width+5||this.right<-5)return this.remove=!0},b.prototype.implode=function(){var a;return this.width<.1*this.originalWidth?(delete Globals.scene.sprites[this.id],delete Globals.scene.world.foamEnemies[this.id]):(this.x+=this.width*.05,this.y+=this.height*.05,this.width*=.9,this.height*=.9,a=this,setTimeout(function(){return a.implode()},10))},b}(Sprite),module&&(module.exports=Enemy);var Constants,Enemy,Sprite,__hasProp=Object.prototype.hasOwnProperty,__extends=function(a,b){function d(){this.constructor=a}for(var c in b)__hasProp.call(b,c)&&(a[c]=b[c]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};module&&(Sprite=require("./sprite"),Constants=require("./constants")),Enemy=function(a){function b(a){var c,d,e;c=a<=1?1:0,e=(Globals.scene.height-Globals.scene.world.road.height)/2+Globals.scene.world.road.height/8-b.height/2,this.x=c*Globals.scene.width,this.y=e+a*(Globals.scene.world.road.height/4),d=Math.floor(Math.random()*3),this.enemy=b.enemies[d],this.alive=!0,c===0&&(this.x-=b.width),this.originalWidth=b.width,this.originalHeight=b.height,this.bg=b.canvases[d],this.mass=Constants.BALL_MASS,b.__super__.constructor.call(this,this.x,this.y,b.width,b.height,this.bg),this.dirX=c?-1*Globals.sizeRatio:Globals.sizeRatio,this.velocity.x=Globals.scene.enemyVel*this.dirX}return __extends(b,a),b.name="Enemy",b.enemies=["purple","green","white"],b.colors=["#6A0475","#048C0D","#eee"],b.canvases=[],b.width=0,b.height=0,b.fetchCanvases=function(){var a,c,d,e,f,g,h,i;b.width=170*Globals.sizeRatio,b.height=30*Globals.sizeRatio,h=b.enemies,i=[];for(e=f=0,g=h.length;f<g;e=++f)d=h[e],a=document.createElement("canvas"),c=a.getContext("2d"),a.width=b.width,a.height=b.height,c.fillStyle=b.colors[e],c.fillRect(0,0,b.width,b.height),c.drawImage(Globals.Loader.getAsset("bus"),0,0,b.width,b.height),i.push(b.canvases.push(a));return i},b.prototype.incrementPosition=function(a){var c,d,e,f,g,h,i,j,k,l,m,n,o;this.velocity.x=Globals.scene.enemyVel*this.dirX,b.__super__.incrementPosition.call(this,a),i=Globals.scene.world.p1,n=this.right>i.left&&this.right<i.right&&this.top<i.bottom&&this.top>i.top,o=i.right>this.left&&i.right<this.right&&i.top<this.bottom&&i.top>this.top,m=n||o,k=this.left<i.right&&this.left>i.left&&this.top<i.bottom&&this.top>i.top,l=i.left<this.right&&i.left>this.left&&i.top<this.bottom&&i.top>this.top,j=k||l,g=this.right>i.left&&this.right<i.right&&this.bottom>i.top&&this.bottom<i.bottom,h=i.right>this.left&&i.right<this.right&&i.bottom>this.top&&i.bottom<this.bottom,f=g||h,d=this.left<i.right&&this.left>i.left&&this.bottom>i.top&&this.bottom<i.bottom,e=i.left<this.right&&i.left>this.left&&i.bottom>this.top&&i.bottom<this.bottom,c=d||e;if(m||j||f||c)this.enemy==="purple"&&this.alive?(this.implode(),Globals.scene.showMessage("SAFE...")):this.alive&&(Globals.scene.showMessage("OUCH..."),this.stop=!0,Globals.scene.world.p1.stop=!0,setTimeout(function(){return Globals.scene.handleWin()},1800)),this.alive=!1;if(this.left>Globals.scene.width+5||this.right<-5)return this.remove=!0},b.prototype.implode=function(){var a;return this.width<.1*this.originalWidth?(delete Globals.scene.sprites[this.id],delete Globals.scene.world.enemies[this.id]):(this.x+=this.width*.05,this.y+=this.height*.05,this.width*=.9,this.height*=.9,a=this,setTimeout(function(){return a.implode()},10))},b}(Sprite),module&&(module.exports=Enemy);var Constants,Player,Sprite,__hasProp=Object.prototype.hasOwnProperty,__extends=function(a,b){function d(){this.constructor=a}for(var c in b)__hasProp.call(b,c)&&(a[c]=b[c]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};module&&(Sprite=require("./sprite"),Constants=require("./constants")),Player=function(a){function b(a,c,d){this.x=a,this.y=c,this.isP2=d,this.score=0,this.width=Globals.sizeRatio*30*.6,this.height=Globals.sizeRatio*70*.6,this.curDir="Up",this.offset=this.height/2,b.__super__.constructor.call(this,this.x,this.y,this.width,this.height,Globals.Loader.getAsset("playerUp"))}return __extends(b,a),b.name="Player",b.prototype.handleInput=function(a){var b;return b=0,a.left(b)&&this.left>0?this.velocity.x=-3*Globals.sizeRatio:a.right(b)&&this.right<Globals.scene.width?this.velocity.x=3*Globals.sizeRatio:this.velocity.x=0,a.up(b)&&this.top>0?this.velocity.y=-3*Globals.sizeRatio:a.down(b)&&this.bottom<Globals.scene.height?this.velocity.y=3*Globals.sizeRatio:this.velocity.y=0},b.prototype.toggleDirection=function(){var a;return a=this.curDir==="Up"?"Down":"Up",this.bg=Globals.Loader.getAsset("player"+a),this.curDir=a,this.offset*=-1},b.prototype.incrementPosition=function(a){return b.__super__.incrementPosition.call(this,a),this.curDir==="Up"?this.top+=this.offset:this.bottom+=this.offset},b.prototype.draw=function(a){return b.__super__.draw.call(this,a)},b}(Sprite),module&&(module.exports=Player);var Constants,Helpers,Player,Sprite,World;module&&(Constants=require("./constants"),Helpers=require("./helpers"),Sprite=require("./sprite"),Player=require("./player")),World=function(){function a(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o;this.width=a,this.height=b,this.input=c,this.lastStep=null,this.clock=0,this.shots={},this.enemies={},this.foamEnemies={},a=50*Globals.sizeRatio,b=50*Globals.sizeRatio,this.p1=new Player(this.width/2-a/2,this.height-b,!1),n=this.width,m=this.height*.7,l=document.createElement("canvas"),l.height=m,l.width=n,j=l.getContext("2d"),j.drawImage(Globals.Loader.getAsset("road"),0,0,n,m),this.road=new Sprite(0,this.height/2-m/2,n,m,l),i=this.width*.2,e=this.width*.2,f=document.createElement("canvas"),f.height=e,f.width=i,d=f.getContext("2d"),d.drawImage(Globals.Loader.getAsset("building"),0,0,i,e),this.building1=new Sprite(50,this.height*.88,i,e,f),this.building2=new Sprite(this.width-i-50,this.height*.88,i,e,f),h=document.createElement("canvas"),h.width=this.width/1.2,h.height=this.height*.1,d=h.getContext("2d"),g=Globals.Loader.getAsset("bush");for(k=o=0;o<10;k=++o)d.drawImage(g,k*h.width/10,0,h.height,h.height);i=this.width*.1,e=this.height*.1,this.bushes=new Sprite(200,this.height*.95-e,h.width,h.height,h)}return a.name="World",a.prototype.reset=function(){var a,b,c,d;c=Globals.scene,c.enemyVel=5*Constants.ENEMY_VEL,clearInterval(c.timeInterval);if(c.loadingEnemy){d=c.loadingEnemy;for(a in d)b=d[a],clearTimeout(b),delete c.loadingEnemy[a]}return this.numFrames=1},a.prototype.step=function(a,b){var c,d,e,f,g,h,i;f=(new Date).getTime(),g=Constants.TICK_DURATION,this.lastStep&&(a||(a=f-this.lastStep)),a||(a=g),b||(this.lastStep=f);if(a>=1.3*g&&this.deterministic){while(a>0)e=a>=1.3*g?g:a,this.step(e,b),a-=e;return}this.deterministic&&(a=g),this.numFrames=a/g,this.clock+=a,this.handleInput(),h=this.enemies;for(d in h)c=h[d],c&&c.incrementPosition(this.numFrames);i=this.foamEnemies;for(d in i)c=i[d],c&&c.incrementPosition(this.numFrames);return this.p1.incrementPosition(this.numFrames)},a.prototype.handleInput=function(){return this.p1.handleInput(this.input)},a.prototype.getState=function(){return{p1:this.p1.getState(),clock:this.clock}},a.prototype.setState=function(a){return this.p1.setState(a.p1)},a.prototype.getInput=function(){return{p1:this.input.getState(0)}},a.prototype.setInput=function(a){if(!a)return;if(a.p1)return this.input.setState(a.p1,0)},a.prototype.setFrame=function(a){if(!a)return;return this.setState(a.state),this.setInput(a.input)},a.prototype.getFrame=function(){return{state:this.getState(),input:this.getInput()}},a}(),module&&(module.exports=World);var LoadingScene,__hasProp=Object.prototype.hasOwnProperty,__extends=function(a,b){function d(){this.constructor=a}for(var c in b)__hasProp.call(b,c)&&(a[c]=b[c]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};LoadingScene=function(a){function b(){this.loadStarted=!1,this.progress=0,b.__super__.constructor.call(this)}return __extends(b,a),b.name="LoadingScene",b.prototype.start=function(){var a;return a=this,this.loadStarted||(this.loadStarted=!0,Globals.Loader.loadProgress(function(b){return a.loadProgress(b,a)}),Globals.Loader.loadComplete(function(){return a.loadComplete()}),Globals.Loader.load(Constants.ASSETS)),b.__super__.start.call(this)},b.prototype.loadComplete=function(){return Globals.Manager.popScene(),Globals.scene=new NickVsBus,Globals.Manager.pushScene(Globals.scene)},b.prototype.loadProgress=function(a,b){return this.progress=a,b.next()},b.prototype.step=function(a){if(!this.ctx)return;return this.ctx.clearRect(0,0,this.width,this.height),this.ctx.fillStyle="#444",this.ctx.fillRect(0,0,this.width,this.height),this.ctx.strokeStyle="#111",this.ctx.lineWidth=1,this.ctx.roundRect(Helpers.round(this.center.x-35),Helpers.round(this.center.y-5),70,10,2).stroke(),this.ctx.fillStyle="#444",this.ctx.roundRect(Helpers.round(this.center.x-35),Helpers.round(this.center.y-5),70,10,2).fill(),this.ctx.fillStyle="#0f0",this.ctx.roundRect(Helpers.round(this.center.x-35),Helpers.round(this.center.y-5),70*this.progress,10,2).fill(),this.ctx.font="12px Monaco, Courier New, Courier, san-serif",this.ctx.textAlign="center",this.ctx.fillStyle="#bbb",this.ctx.fillText("Loading...",Helpers.round(this.center.x),Helpers.round(this.center.y+25))},b}(Scene);var NickVsBus,__hasProp=Object.prototype.hasOwnProperty,__extends=function(a,b){function d(){this.constructor=a}for(var c in b)__hasProp.call(b,c)&&(a[c]=b[c]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};NickVsBus=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return __extends(b,a),b.name="NickVsBus",b.prototype.init=function(a){var c,d,e,f,g=this;return Globals.windowSize&&Globals.windowSize.width?(this.width=Globals.windowSize.width,this.height=Globals.windowSize.height):(this.width=800,this.height=447),this.world||(this.world=new World(this.width,this.height,Globals.Input)),f=Globals.Loader,c=document.createElement("canvas"),e=c.getContext("2d"),e.fillStyle="#ccc",e.fillRect(0,0,this.width,this.height),this.bg=new StretchySprite(0,0,this.width,this.height,200,1,c),this.freezeGame=!0,this.initialLoad=!0,this.refreshSprites(),this.loadingEnemy={},this.world.reset(),this.last=0,this.time=15,this.score=0,this.displayMsg="\n Instructions:",this.displayMsg+="\n Cross road back and forth, knock out foam sword foes",this.displayMsg+="\n Use arrow keys to move",this.displayMsg+="\n Getting hit by a green or white bus will kill you",this.displayMsg+="\n Purple buses don't do damage, because you're Nick",this.displayMsg+="\n ... and you're pretty much invincible",this.displayMsg+="\n You have 15 seconds each time to cross the road",this.displayMsg+="\n\nClick anywhere to start",this.keyState={left:!1,right:!1,up:!1},a||(this.world.handleInput=function(){return g.world.p1.handleInput(Globals.Input)}),b.__super__.init.call(this),d=Globals.Manager.canvas,g=this,d.addEventListener("click",function(){return g.handleMouseDown()},!0),d.addEventListener("touchstart",function(){return g.handleMouseDown()},!0)},b.prototype.refreshSprites=function(){var a,b;this.sprites=[],this.sprites.push(this.bg,this.world.road,this.world.bushes,this.world.building1,this.world.building2,this.world.p1),a=new GamePad({left:[0,this.height-Constants.BOTTOM,this.width/4,Constants.BOTTOM],right:[this.width/4,this.height-Constants.BOTTOM,this.width/4,Constants.BOTTOM],up:[2*this.width/4,this.height-Constants.BOTTOM,this.width/4,Constants.BOTTOM],down:[3*this.width/4,this.height-Constants.BOTTOM,this.width/4,Constants.BOTTOM]}),this.buttons.gamepad=a;if("ontouchstart"in window?1:0)return b=new Sprite(0,this.height*.85,this.width,this.height*.15,Globals.Loader.getAsset("gamepad")),this.sprites.push(b)},b.prototype.start=function(){var a=this;return document.getElementById("ui2").style.display="none",document.getElementById("ui").style.display="none",this.refreshSprites(),this.time=15,this.score=0,this.world.enemies={},this.world.foamEnemies={},this.displayMsg=null,this.freezeGame=!1,this.world.p1.stop=!1,this.world.p1.x=this.width/2-this.world.p1.width/2,this.world.p1.y=this.height-this.world.p1.height,this.world.p1.curDir==="Down"&&this.world.p1.toggleDirection(),this.timeInterval=setInterval(function(){return a.time===1?(a.time--,a.handleWin()):a.time--},1e3),Enemy.fetchCanvases(),this.interval=2500,this.loadEnemy(0),this.loadEnemy(1),this.loadEnemy(2),this.loadEnemy(3),this.loadFoamEnemy("top")},b.prototype.handleMouseDown=function(a){if(this.freezeGame)return this.start(),this.world.lastStep=!1},b.prototype.loadFoamEnemy=function(a){var b,c;return b=new FoamEnemy(a),c=this.sprites.push(b)-1,this.sprites[c].id=c,this.world.foamEnemies[c]=b},b.prototype.loadEnemy=function(a){var b,c,d;if(!this.freezeGame)return b=new Enemy(a),c=this.sprites.push(b)-1,this.sprites[c].id=c,this.world.enemies[c]=b,d=this,this.loadingEnemy[a]=setTimeout(function(){return d.loadEnemy(a)},(.8+.4*Math.random())*(10*this.width/this.enemyVel))},b.prototype.showMessage=function(a){var b,c;if(window.innerWidth<450)return;return b=new Message(a,this.world.p1.x,this.world.p1.y),this.sprites.push(b),c=setInterval(function(){return b.opacity>.005?(b.opacity-=.005,b.fontSize+=.2):(b.remove=!0,clearInterval(c))},10)},b.prototype.inputChanged=function(){var a,b,c,d,e,f;c=Globals.Input,a=!1,f=this.keyState;for(d in f){if(!__hasProp.call(f,d))continue;e=f[d],b=c[d](0),e!==b&&(a||(a={}),a[d]=b,this.keyState[d]=b)}return a},b.prototype.pause=function(){return this.freezeGame=!0,this.displayMsg="Paused. Click to resume"},b.prototype.draw=function(){var a,b,c,d,e,f,g,h,i,j,k;this.ctx.clearRect(0,0,this.width,this.height),j=this.sprites;for(a=f=0,h=j.length;f<h;a=++f)e=j[a],e&&!e.remove&&e.draw(this.ctx);this.ctx.font="bold 18px "+Constants.MSG_FONT,this.ctx.fillStyle="#ffffff",this.ctx.textAlign="left",b="Score: "+this.score,this.ctx.lineWidth=1,this.ctx.strokeStyle="rgba( 0, 0, 0, 0.8 )",this.ctx.fillText(b,15,25),window.innerWidth>500&&!1&&this.ctx.strokeText(b,15,25),this.ctx.textAlign="right",b="Time: "+this.time,this.ctx.fillText(b,this.width-15,25),window.innerWidth>500&&!1&&this.ctx.strokeText(b,this.width-15,25);if(this.displayMsg){this.ctx.font="bold "+36*Globals.sizeRatio+"px "+Constants.MSG_FONT,this.ctx.fillStyle="#ffffff",this.ctx.lineWidth=1,this.ctx.strokeStyle="rgba( 0, 0, 0, 0.8 )",this.ctx.textAlign="center",this.ctx.fillText("Nick VS. Bus",this.width/2-20,this.height*.33),window.innerWidth>500&&!1&&this.ctx.strokeText("Nick VS. Bus",this.width/2-20,this.height*.33),this.ctx.fillStyle="#ffffff",this.ctx.lineWidth=.5,this.ctx.strokeStyle="rgba( 0, 0, 0, 0.8 )",this.ctx.textAlign="center",c=this.displayMsg.split("\n");if(c.length>0){k=[];for(a=g=0,i=c.length;g<i;a=++g)b=c[a],a>=5?d=this.height*.08:d=5,this.ctx.font="bold "+12*Globals.sizeRatio+"px "+Constants.MSG_FONT,this.ctx.fillText(b,this.width/2-20,this.height*.33+d+a*14*Globals.sizeRatio),window.innerWidth>500&&!1?k.push(this.ctx.strokeText(b,this.width/2-20,this.height*.33+d+a*14*Globals.sizeRatio)):k.push(void 0);return k}}},b.prototype.incrementScore=function(a){return a==null&&(a=1),this.score+=a,this.showMessage("+"+a)},b.prototype.handleWin=function(a){var b,c,d,e,f,g,h,i,j,k,l=this;if(!this.freezeGame){this.freezeGame=!0,this.world.reset(),this.displayMsg="\nGame over!\nClick to play again",c=document.getElementById("content"),c.innerHTML="",d=new Clay.Leaderboard({id:14,showPersonal:!0,filters:["all","month","day","hour"],tabs:[{id:14,title:"Cumulative",cumulative:!0,showPersonal:!0,filters:["all","month","day","hour"]},{id:14,title:"Personal Best",self:!0,filters:["all","month","day","hour"]}]}),e=document.createElement("p"),h=document.createElement("a"),h.href="javascript: void( 0 );",k=document.createTextNode("Post My High Score"),h.appendChild(k),i=!1,h.onclick=function(){if(!i)return d.post({score:l.score},function(){return d.show({html:"<a href='javascript: void( 0 );' onclick='facebook("+
l.score+");'>Post to Facebook</a> or <a href='javascript: void( 0 );' onclick='tweet("+l.score+");'>Post to Twitter</a>"})}),i=!0},e.appendChild(h),f=document.createElement("p"),j=document.createElement("a"),j.href="javascript: void( 0 );",k=document.createTextNode("View High Scores"),j.appendChild(k),j.onclick=function(){return d.show()},f.appendChild(j),g=document.createElement("p"),b=document.createElement("a"),b.href="javascript: void( 0 );",k=document.createTextNode("About the Developer"),b.appendChild(k),b.onclick=function(){var a,b;return a=document.getElementById("ui-content"),a.innerHTML="<p>My name is Austin Hallock, I'm a CS major at the University of Texas. I'm also co-founder of this site, <a href='http://clay.io' target='_BLANK'>Clay.io</a>, which is a hub for games that are playable in a browser <em>and</em> on your phone. I like making games :)</p><p>Twitter: <a href='http://twitter.com/austinhallock' target='_BLANK'>@austinhallock</a></p>",a.style.display="block",b=document.getElementById("ui"),b.setAttribute("style","display: block !important"),Clay.Stats.logStat({name:"aboutClick",quantity:1})},g.appendChild(b),c.appendChild(e),c.appendChild(f),c.appendChild(g),document.getElementById("ui2").style.display="block",this.score>5e3&&(new Clay.Achievement({id:75})).award(),this.score>1e4&&(new Clay.Achievement({id:76})).award(),this.score>2e4&&(new Clay.Achievement({id:77})).award(),this.score>5e4&&(new Clay.Achievement({id:78})).award(),this.score>1e5&&(new Clay.Achievement({id:79})).award();if(this.score>15e4)return(new Clay.Achievement({id:80})).award()}},b.prototype.step=function(a){return this.next(),this.freezeGame?this.draw():(this.world.step(),this.draw())},b.prototype.buttonPressed=function(a){return Globals.Manager.popScene()},b}(Scene);var InputSnapshot,__hasProp=Object.prototype.hasOwnProperty;InputSnapshot=function(){function a(){this.states=[{left:!1,right:!1,up:!1}]}return a.name="InputSnapshot",a.prototype.get=function(a,b){return this.states[b][a]},a.prototype.getState=function(a){var b,c,d,e;c={},e=this.states[a];for(b in e){if(!__hasProp.call(e,b))continue;d=e[b],c[b]=d}return c},a.prototype.setState=function(a,b){var c,d,e;e=[];for(c in a){if(!__hasProp.call(a,c))continue;d=a[c],e.push(this.states[b][c]=a[c])}return e},a.prototype.left=function(a){return this.states[a].left},a.prototype.right=function(a){return this.states[a].right},a.prototype.up=function(a){return this.states[a].up},a}(),module&&(module.exports=InputSnapshot);var getWindowSize;window.addEventListener("load",function(){var a,b;return a=function(){var a,b,c,d,e,f,g,h,i;f=window.devicePixelRatio||1,b=document.getElementById("canvas"),i=getWindowSize(),h=i.width,e=i.height,g=window.devicePixelRatio||1,h/1.79<e?(b.width=h*g,b.height=Math.floor(h/1.79)*g,b.style.width=h,b.style.height=Math.floor(h/1.79)):(b.width=Math.floor(e*1.79)*g,b.height=e*g,b.style.width=Math.floor(e*1.79),b.style.height=e,d=document.getElementById("center"),d&&(d.style.width=Math.floor(e*1.79)+"px")),Globals.windowSize={width:b.width,height:b.height},Globals.sizeRatio=b.width/800;if(Globals.scene)return Globals.scene.width=Globals.windowSize.width,Globals.scene.height=Globals.windowSize.height,Globals.scene.world=new World(Globals.windowSize.width,Globals.windowSize.height,Globals.Input),a=document.createElement("canvas"),c=a.getContext("2d"),c.fillStyle="#ccc",c.fillRect(0,0,Globals.windowSize.width,Globals.windowSize.height),Globals.scene.bg=new StretchySprite(0,0,Globals.windowSize.width,Globals.windowSize.height,200,1,a),Globals.scene.refreshSprites()},window.onresize=a,b=function(){var b;return a(),Globals.Manager.canvas=canvas,Globals.Manager.ctx=Globals.Manager.canvas.getContext("2d"),Globals.Input=new Input,b=new LoadingScene,Globals.Manager.pushScene(b),b.start()},b()}),window.addEventListener("keypress",function(a){var b;b=a||window.event;if(b.keyCode===83||b.keyCode===115)return Globals.scene&&Globals.scene.pause(),new Clay.Screenshot}),this.facebook=function(a){return(new Clay.Facebook).post({message:"I just scored "+a+" in Nick vs. Bus!",link:"http://nickvsbus.clay.io"})},this.tweet=function(a){return(new Clay.Twitter).post({message:"I just scored "+a+" in Nick vs. Bus! See if you can beat that: http://nickvsbus.clay.io"})},getWindowSize=function(){var a,b;return b=0,a=0,typeof window.innerWidth=="number"?(b=window.innerWidth,a=window.innerHeight):document.documentElement&&(document.documentElement.clientWidth||document.documentElement.clientHeight)?(b=document.documentElement.clientWidth,a=document.documentElement.clientHeight):document.body&&(document.body.clientWidth||document.body.clientHeight)&&(b=document.body.clientWidth,a=document.body.clientHeight),{height:a,width:b}}